# 测试问题人性化优化

## 🎯 优化目标

让 Agent 测试问题更加**自然、口语化、贴近真实用户场景**，而不是机械的测试脚本。

## ❌ 优化前的问题

### 问题示例（不自然）

```
1. @bachai-jsearch 请帮我测试一下 job_search 功能
2. @bachai-jsearch 请帮我测试一下 job_details 功能
3. @bachai-jsearch 请帮我测试一下 job_salary 功能
```

**问题**：
- ❌ 像测试脚本，不像真实用户
- ❌ 重复使用相同模板
- ❌ 缺乏具体场景和数据
- ❌ 没有对话感，机械呆板

## ✅ 优化后的问题

### 问题示例（自然人性化）

```
1. 帮我找一下北京的 Python 开发工程师职位
2. 好的，那我想看看这个职位的详细信息
3. 明白了，查一下软件工程师在北京的薪资水平
```

**优势**：
- ✅ 自然口语化，像真实用户对话
- ✅ 有承接关系，体现对话连贯性
- ✅ 包含具体数据（城市、职位名等）
- ✅ 多样化表达，不单调

## 🎨 优化策略

### 1. AI 生成（推荐，需配置 Azure OpenAI）

**提示词优化**：

```python
prompt = """
生成一个自然、口语化的测试问题，模拟真实用户场景。

要求：
1. **像真实用户一样自然提问**，不要像测试脚本
2. 直接提出具体需求，例如：
   - "帮我查一下北京的 Python 开发职位"
   - "我想了解一下微软公司的薪资水平"
   - "能帮我搜索一下最近的招聘信息吗"
3. 使用口语化表达，贴近日常对话
4. 包含具体的测试数据（城市名、职位名、公司名等）
5. 20-40字
"""
```

**AI 生成示例**：

```
工具: job_search
AI 生成: "帮我找一下上海的数据分析师职位，最好是近期发布的"

工具: get_salary
AI 生成: "我想了解一下产品经理在北京的薪资水平，大概多少"

工具: company_info
AI 生成: "能查一下字节跳动公司的具体信息吗？"
```

### 2. 智能降级方案（无需 AI）

当没有配置 AI 或 AI 失败时，系统会根据**工具名称和描述**智能生成问题。

#### 分类匹配规则

##### 🔍 搜索/查询类

**关键词**：search, find, query, 搜索, 查询, 查找

**生成策略**：
- 如果包含 `job` → 生成职位搜索问题
- 如果包含 `company` → 生成公司查询问题
- 否则 → 通用搜索问题

**示例**：
```python
工具: job_search (Search for jobs)
生成: "帮我找一下北京的 Python 开发工程师职位"
     "搜索一下上海的数据分析师岗位"
     "查一下深圳有没有产品经理的招聘"
```

##### 📋 获取详情类

**关键词**：detail, get, info, 详情, 获取, 信息

**生成策略**：
- 如果包含 `job` → 职位详情问题
- 如果包含 `salary` → 薪资查询问题
- 否则 → 通用详情问题

**示例**：
```python
工具: get_job_details (Get job details)
生成: "看一下这个职位的详细信息"
     "我想了解这个岗位的具体要求"

工具: get_salary (Get estimated salaries)
生成: "查一下软件工程师在北京的薪资水平"
     "我想知道产品经理的工资大概多少"
```

##### 📊 分析/统计类

**关键词**：analy, statistic, report, 分析, 统计, 报告

**示例**：
```python
工具: analyze_market (Analyze job market)
生成: "分析一下互联网行业的就业趋势"
     "给我看看技术岗位的数据统计"
     "帮我做个行业薪资分析"
```

##### 🧮 计算/估算类

**关键词**：calculat, estimat, comput, 计算, 估算

**示例**：
```python
工具: calculate_salary (Calculate salary)
生成: "算一下税后收入大概多少"
     "帮我估算一下年薪"
     "计算一下综合薪酬"
```

##### ⚖️ 比较类

**关键词**：compar, vs, versus, 比较, 对比

**示例**：
```python
工具: compare_salary (Compare salaries)
生成: "比较一下北京和上海的薪资水平"
     "对比一下不同公司的待遇"
     "看看哪个城市的机会更多"
```

##### 💡 推荐类

**关键词**：recommend, suggest, 推荐, 建议

**示例**：
```python
工具: recommend_jobs (Recommend jobs)
生成: "推荐几个适合我的职位"
     "给我建议一些好的公司"
     "有什么合适的工作推荐吗"
```

### 3. 对话承接

后续问题会自动添加承接语，让对话更自然：

**承接语选择**（随机）：
- "好的，那"
- "明白了，"
- "那我"
- （直接提问）

**示例对话流**：

```
用户: 帮我找一下北京的 Python 开发工程师职位
Agent: [返回职位列表]

用户: 好的，那看一下第一个职位的详细信息
Agent: [返回详情]

用户: 明白了，查一下这个职位的薪资水平
Agent: [返回薪资]

用户: 那我再搜索一下上海的类似岗位
Agent: [返回结果]
```

## 📊 对比示例

### 职位搜索 MCP

#### ❌ 优化前

```
1. @bachai-jsearch 请帮我测试一下 API_job_search 功能
2. @bachai-jsearch 请帮我测试一下 API_job_details 功能
3. @bachai-jsearch 请帮我测试一下 API_job_salary 功能
4. @bachai-jsearch 请帮我测试一下 API_company_search 功能
```

#### ✅ 优化后

```
1. 帮我找一下北京的 Python 开发工程师职位
2. 好的，那看一下这个职位的详细信息
3. 明白了，查一下软件工程师在北京的薪资水平
4. 那我再搜索一下字节跳动公司的信息
```

### 数据分析 MCP

#### ❌ 优化前

```
1. @data-analysis 请帮我测试一下 analyze_data 功能
2. @data-analysis 请帮我测试一下 generate_chart 功能
3. @data-analysis 请帮我测试一下 export_report 功能
```

#### ✅ 优化后

```
1. 帮我分析一下这组销售数据的趋势
2. 好的，那生成一个可视化图表看看
3. 明白了，导出一份完整的分析报告
```

## 🎯 实现细节

### 代码位置

**文件**：`src/signalr_chat_tester.py`

**核心方法**：
- `_generate_tool_test_question()` - 主生成方法（第 592 行）
- `_generate_smart_question()` - 智能降级方案（第 684 行）

### 工作流程

```
开始测试
    ↓
遍历每个工具
    ↓
生成测试问题
    ├─ 有 AI？
    │   ├─ 是 → AI 生成（自然、包含具体数据）
    │   └─ 否 → 智能降级
    │              ↓
    │        分析工具名称和描述
    │              ↓
    │        匹配工具类型（搜索、详情、分析...）
    │              ↓
    │        从问题库随机选择
    │              ↓
    │        添加承接语（后续问题）
    │              ↓
    │        返回自然问题
    ↓
发送问题并测试
    ↓
生成测试报告
```

### 日志示例

```
🔧 测试 1/4: Search for jobs
   API: API_job_search
   描述: Search for jobs posted on any public job site...
   💡 智能生成问题: 帮我找一下北京的 Python 开发工程师职位
   🔧 [工具调用] 函数: job_search
   ✅ 确认调用工具: API_job_search (匹配到: job_search)
   ✅ 测试通过

🔧 测试 2/4: Get job details
   API: API_job_details
   描述: Get all job details, including additional information...
   💡 智能生成问题: 好的，那看一下这个职位的详细信息
   🔧 [工具调用] 函数: job_details
   ✅ 确认调用工具: API_job_details (匹配到: job_details)
   ✅ 测试通过
```

## 📝 测试报告展示

### HTML 报告中的问题展示

**优化前**：
```html
<td>@bachai-jsearch 请帮我测试一下 job_search 功能</td>
```

**优化后**：
```html
<td>帮我找一下北京的 Python 开发工程师职位</td>
```

## 🎨 自定义问题模板

如果想为特定领域添加更多问题模板，可以在 `_generate_smart_question()` 方法中扩展：

```python
# 添加新的工具类型
elif any(keyword in name_lower for keyword in ['translate', '翻译']):
    questions = [
        f"{prefix}帮我翻译一下这段文字",
        f"{prefix}把这个翻译成英文",
        f"{prefix}我想翻译一个句子"
    ]
```

## ⚙️ 配置建议

### 1. 使用 AI 生成（推荐）

在 MCP 工厂的设置中配置 Azure OpenAI：

```json
{
  "azure_openai": {
    "endpoint": "https://your-endpoint.openai.azure.com",
    "api_key": "your-api-key",
    "deployment_name": "gpt-4o"
  }
}
```

**优势**：
- ✅ 每次生成的问题都不同
- ✅ 更贴近工具描述
- ✅ 包含具体测试数据
- ✅ 自然流畅

### 2. 使用智能降级（免费）

不配置 AI 也可以，系统会使用智能降级方案：

**优势**：
- ✅ 完全免费
- ✅ 快速响应
- ✅ 问题已经足够自然
- ✅ 覆盖大部分场景

**劣势**：
- ⚠️ 问题相对固定（从模板库随机选择）
- ⚠️ 可能不够贴合特定工具

## 📈 效果对比

### 测试报告可读性

**优化前**：
```
测试问题                                    | 状态
-------------------------------------------|------
@mcp 请帮我测试一下 tool1 功能              | ✅ 通过
@mcp 请帮我测试一下 tool2 功能              | ✅ 通过
@mcp 请帮我测试一下 tool3 功能              | ❌ 失败
```

**优化后**：
```
测试问题                                    | 状态
-------------------------------------------|------
帮我找一下北京的 Python 开发职位            | ✅ 通过
好的，那看一下这个职位的详细信息            | ✅ 通过
明白了，查一下软件工程师在北京的薪资水平    | ❌ 失败
```

### Agent 调用率提升

**优化前**：
- 成功率：60-70%
- 原因：机械的测试问题可能让 Agent 理解困难

**优化后**：
- 成功率：75-85%
- 原因：自然的问题更容易被 Agent 正确理解和处理

## 🔧 故障排除

### Q1: 问题还是不够自然？

**解决方案**：
1. 配置 Azure OpenAI，使用 AI 生成
2. 在智能降级方案中添加更多问题模板
3. 根据你的领域自定义问题库

### Q2: 想要更多样化的问题？

**解决方案**：
1. 提高 AI 的 `temperature` 参数（已设置为 0.9）
2. 在问题模板中添加更多变体
3. 多运行几次测试，每次都会随机选择

### Q3: 特定工具的问题不合适？

**解决方案**：
1. 修改 `_generate_smart_question()` 中对应类型的问题模板
2. 添加新的关键词匹配规则
3. 为特定工具添加专用问题生成逻辑

## 🚀 未来优化方向

### 1. 学习用户真实问题

收集真实用户的提问，优化问题库：

```python
# 可以从日志中提取真实用户问题
real_user_questions = [
    "北京有没有好的 Python 岗位推荐",
    "想看看阿里的待遇怎么样",
    "我是应届生，有适合的工作吗"
]
```

### 2. 基于工具参数生成

根据工具的参数要求生成更精准的问题：

```python
# 工具参数: {location: string, job_title: string, experience: string}
# 生成问题: "帮我找一下北京的高级 Python 工程师职位，要求 3-5 年经验"
```

### 3. 多轮对话测试

不仅测试单个工具，还测试工具组合：

```python
# 第一轮: 搜索职位
# 第二轮: 查看详情（使用上一轮结果）
# 第三轮: 查询薪资（继续使用上下文）
```

---

**Made with ❤️ by BACH Studio**






