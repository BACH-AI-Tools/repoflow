# âœ… è·¯ç”±å ç”¨è‡ªåŠ¨æ¢è·¯ç”±

## ğŸ¯ é—®é¢˜

ç”¨æˆ·åé¦ˆï¼š
> "ç¬¬ä¸€æ¬¡å‘å¸ƒå®Œä¹‹åï¼Œè€æ˜¯æç¤ºæˆ‘ MCP è·¯ç”±é…ç½®å·²è¢«å ç”¨ï¼Œè¢«å ç”¨å°±æ¢ä¸ªå…¶ä»–çš„å‘—ï¼Œåˆ«ä¸€ç›´æŠ¥é”™"

## âœ… è§£å†³æ–¹æ¡ˆ

### è‡ªåŠ¨æ£€æµ‹è·¯ç”±å ç”¨å¹¶é‡è¯•

å½“æ£€æµ‹åˆ°è·¯ç”±å ç”¨é”™è¯¯æ—¶ï¼Œè‡ªåŠ¨ä¿®æ”¹è·¯ç”±å‰ç¼€å¹¶é‡è¯•åˆ›å»ºã€‚

## ğŸ”§ å®ç°é€»è¾‘

### ä¿®æ”¹çš„æ–‡ä»¶

**`emcp_manager.py`** - `create_mcp_template()` æ–¹æ³•

### æ ¸å¿ƒä»£ç 

```python
def create_mcp_template(
    self,
    template_data: Dict,
    retry_count: int = 0,
    max_retries: int = 3,
    auto_login_on_401: bool = True,
    route_retry_count: int = 0  # â­ æ–°å¢ï¼šè·¯ç”±é‡è¯•è®¡æ•°
) -> Dict:
    # ... å‘é€åˆ›å»ºè¯·æ±‚ ...
    
    data = response.json()
    
    if data.get('err_code') != 0:
        error_msg = data.get('err_message', 'æœªçŸ¥é”™è¯¯')
        
        # â­ æ£€æµ‹è·¯ç”±å ç”¨é”™è¯¯
        if ('è·¯ç”±' in error_msg and 'å ç”¨' in error_msg) or \
           ('route' in error_msg.lower() and ('exist' in error_msg.lower() or 'occupied' in error_msg.lower())):
            
            if route_retry_count < 5:  # æœ€å¤šå°è¯•5æ¬¡
                HTTPLogger.log(f"\nâš ï¸ æ£€æµ‹åˆ°è·¯ç”±å ç”¨: {error_msg}")
                HTTPLogger.log(f"ğŸ”„ è‡ªåŠ¨æ¢è·¯ç”±é‡è¯• ({route_retry_count + 1}/5)...")
                
                # ä¿®æ”¹è·¯ç”±å‰ç¼€ï¼ˆæ·»åŠ éšæœºæ•°å­—åç¼€ï¼‰
                import random
                original_prefix = template_data.get('route_prefix', '')
                
                # å¦‚æœå·²ç»æœ‰æ•°å­—åç¼€ï¼Œç§»é™¤
                if route_retry_count > 0:
                    original_prefix = ''.join(c for c in original_prefix if not c.isdigit())
                
                # æˆªæ–­ä»¥ç¡®ä¿æœ‰ç©ºé—´æ·»åŠ æ•°å­—
                if len(original_prefix) > 8:
                    original_prefix = original_prefix[:8]
                
                # æ·»åŠ éšæœºæ•°å­—åç¼€
                new_suffix = random.randint(10, 99)
                new_prefix = f"{original_prefix}{new_suffix}"
                
                # ç¡®ä¿ä¸è¶…è¿‡10ä¸ªå­—ç¬¦
                if len(new_prefix) > 10:
                    new_prefix = new_prefix[:10]
                
                template_data['route_prefix'] = new_prefix
                HTTPLogger.log(f"   âœ… æ–°è·¯ç”±å‰ç¼€: {new_prefix}")
                
                # é€’å½’è°ƒç”¨ï¼Œä½¿ç”¨æ–°è·¯ç”±é‡è¯•
                return self.create_mcp_template(
                    template_data,
                    retry_count=retry_count,
                    max_retries=max_retries,
                    auto_login_on_401=auto_login_on_401,
                    route_retry_count=route_retry_count + 1  # â­ å¢åŠ è®¡æ•°
                )
        
        raise Exception(f"åˆ›å»ºæ¨¡æ¿å¤±è´¥: {error_msg}")
```

## ğŸ“Š å·¥ä½œæµç¨‹

### æ­£å¸¸æƒ…å†µ
```
1. åˆ›å»ºæ¨¡æ¿
   route_prefix: dataanaly
   â†“
2. âœ… åˆ›å»ºæˆåŠŸ
```

### è·¯ç”±å ç”¨æƒ…å†µ

```
1. åˆ›å»ºæ¨¡æ¿
   route_prefix: dataanaly
   â†“
2. âŒ é”™è¯¯: MCP è·¯ç”±é…ç½®å·²è¢«å ç”¨
   â†“
3. âš ï¸ æ£€æµ‹åˆ°è·¯ç”±å ç”¨
   ğŸ”„ è‡ªåŠ¨æ¢è·¯ç”±é‡è¯• (1/5)
   âœ… æ–°è·¯ç”±å‰ç¼€: dataanaly42  â­
   â†“
4. é‡æ–°åˆ›å»ºæ¨¡æ¿
   route_prefix: dataanaly42
   â†“
5. âœ… åˆ›å»ºæˆåŠŸï¼
```

### å¤šæ¬¡å ç”¨æƒ…å†µ

```
å°è¯• 1: dataanaly â†’ âŒ å ç”¨
å°è¯• 2: dataanaly42 â†’ âŒ å ç”¨
å°è¯• 3: dataanaly73 â†’ âŒ å ç”¨
å°è¯• 4: dataanaly19 â†’ âœ… æˆåŠŸï¼
```

## ğŸ“‹ æ—¥å¿—è¾“å‡º

### ç¬¬ä¸€æ¬¡å ç”¨

```
======================================================================
ğŸ“¥ HTTP å“åº”: 200
ğŸ“‹ å“åº”æ•°æ®:
   {
     "err_code": 1,
     "err_message": "MCP è·¯ç”±é…ç½®å·²è¢«å ç”¨"
   }
======================================================================

âš ï¸ æ£€æµ‹åˆ°è·¯ç”±å ç”¨: MCP è·¯ç”±é…ç½®å·²è¢«å ç”¨  â­
ğŸ”„ è‡ªåŠ¨æ¢è·¯ç”±é‡è¯• (1/5)...  â­
   âœ… æ–°è·¯ç”±å‰ç¼€: dataanaly42  â­

======================================================================
ğŸ“¤ HTTP è¯·æ±‚: POST https://sit-emcp.kaleido.guru/api/Template/create_mcp_template
   route_prefix: dataanaly42  â­
======================================================================

======================================================================
ğŸ“¥ HTTP å“åº”: 200
   {
     "err_code": 0,
     "body": {
       "templateId": "xxx"
     }
   }
======================================================================

âœ… æ¨¡æ¿å·²åˆ›å»ºï¼
âœ… æ¨¡æ¿ID: xxx
```

### å¤šæ¬¡é‡è¯•

```
âš ï¸ æ£€æµ‹åˆ°è·¯ç”±å ç”¨: MCP è·¯ç”±é…ç½®å·²è¢«å ç”¨
ğŸ”„ è‡ªåŠ¨æ¢è·¯ç”±é‡è¯• (1/5)...
   âœ… æ–°è·¯ç”±å‰ç¼€: dataanaly42

âš ï¸ æ£€æµ‹åˆ°è·¯ç”±å ç”¨: MCP è·¯ç”±é…ç½®å·²è¢«å ç”¨
ğŸ”„ è‡ªåŠ¨æ¢è·¯ç”±é‡è¯• (2/5)...
   âœ… æ–°è·¯ç”±å‰ç¼€: dataanaly73

âš ï¸ æ£€æµ‹åˆ°è·¯ç”±å ç”¨: MCP è·¯ç”±é…ç½®å·²è¢«å ç”¨
ğŸ”„ è‡ªåŠ¨æ¢è·¯ç”±é‡è¯• (3/5)...
   âœ… æ–°è·¯ç”±å‰ç¼€: dataanaly19

âœ… æ¨¡æ¿å·²åˆ›å»ºï¼
```

### è¾¾åˆ°æœ€å¤§é‡è¯•æ¬¡æ•°

```
âš ï¸ æ£€æµ‹åˆ°è·¯ç”±å ç”¨: MCP è·¯ç”±é…ç½®å·²è¢«å ç”¨
ğŸ”„ è‡ªåŠ¨æ¢è·¯ç”±é‡è¯• (5/5)...
   âœ… æ–°è·¯ç”±å‰ç¼€: dataanaly88

âŒ è·¯ç”±å ç”¨ä¸”å·²å°è¯•5æ¬¡ï¼Œæ”¾å¼ƒé‡è¯•
âŒ åˆ›å»ºæ¨¡æ¿å¤±è´¥: MCP è·¯ç”±é…ç½®å·²è¢«å ç”¨
```

## ğŸ¯ ç­–ç•¥è®¾è®¡

### 1. éšæœºæ•°å­—åç¼€
```python
new_suffix = random.randint(10, 99)  # 10-99 éšæœºæ•°
new_prefix = f"{original_prefix}{new_suffix}"
```

**ä¼˜åŠ¿**:
- âœ… é™ä½å†²çªæ¦‚ç‡
- âœ… ç®€å•æœ‰æ•ˆ
- âœ… ä¿æŒå¯è¯»æ€§

### 2. ä¿ç•™åŸå§‹å‰ç¼€
```python
# ç§»é™¤æ•°å­—åç¼€ï¼Œä¿ç•™åŸå§‹å‰ç¼€
original_prefix = ''.join(c for c in original_prefix if not c.isdigit())
```

**ä¾‹å­**:
- ç¬¬1æ¬¡: `dataanaly` â†’ `dataanaly42`
- ç¬¬2æ¬¡: `dataanaly42` â†’ `dataanaly` â†’ `dataanaly73`
- ç¬¬3æ¬¡: `dataanaly73` â†’ `dataanaly` â†’ `dataanaly19`

### 3. é•¿åº¦é™åˆ¶
```python
# ç¡®ä¿æœ‰ç©ºé—´æ·»åŠ æ•°å­—
if len(original_prefix) > 8:
    original_prefix = original_prefix[:8]

# æ·»åŠ 2ä½æ•°å­—åç¡®ä¿ä¸è¶…è¿‡10
if len(new_prefix) > 10:
    new_prefix = new_prefix[:10]
```

### 4. æœ€å¤šé‡è¯•5æ¬¡
```python
if route_retry_count < 5:
    # é‡è¯•
else:
    # æ”¾å¼ƒ
```

**ç†ç”±**:
- 5æ¬¡é‡è¯• = 5ä¸ªä¸åŒçš„éšæœºæ•°å­—
- å†²çªæ¦‚ç‡æä½
- é˜²æ­¢æ— é™å¾ªç¯

## ğŸ” é”™è¯¯æ£€æµ‹

### æ”¯æŒçš„é”™è¯¯æ¶ˆæ¯

**ä¸­æ–‡**:
- "MCP è·¯ç”±é…ç½®å·²è¢«å ç”¨"
- "è·¯ç”±å·²å ç”¨"
- "è·¯ç”±å‰ç¼€è¢«å ç”¨"

**è‹±æ–‡**:
- "route already exists"
- "route is occupied"
- "route prefix exists"

### æ£€æµ‹ä»£ç 

```python
if ('è·¯ç”±' in error_msg and 'å ç”¨' in error_msg) or \
   ('route' in error_msg.lower() and ('exist' in error_msg.lower() or 'occupied' in error_msg.lower())):
    # è·¯ç”±å ç”¨ï¼Œè‡ªåŠ¨æ¢è·¯ç”±
```

## ğŸ’¡ ç¤ºä¾‹

### ä¾‹å­ 1: dataanaly

```
åŸå§‹: dataanaly (8å­—ç¬¦)
å°è¯•1: dataanaly42 (10å­—ç¬¦) âœ…
å°è¯•2: dataanaly73 (10å­—ç¬¦) âœ…
å°è¯•3: dataanaly19 (10å­—ç¬¦) âœ…
```

### ä¾‹å­ 2: filesearch

```
åŸå§‹: filesearch (10å­—ç¬¦)
æˆªæ–­: filesear (8å­—ç¬¦ï¼Œä¸ºæ•°å­—ç•™ç©ºé—´)
å°è¯•1: filesear42 (10å­—ç¬¦) âœ…
å°è¯•2: filesear73 (10å­—ç¬¦) âœ…
```

### ä¾‹å­ 3: abc

```
åŸå§‹: abc (3å­—ç¬¦)
å°è¯•1: abc42 (5å­—ç¬¦) âœ…
å°è¯•2: abc73 (5å­—ç¬¦) âœ…
```

## ğŸ¯ ç”¨æˆ·ä½“éªŒ

### ä¿®å¤å‰ âŒ

```
å‘å¸ƒ â†’ è·¯ç”±å ç”¨ â†’ âŒ æŠ¥é”™åœæ­¢
```

ç”¨æˆ·ä½“éªŒï¼š
- âŒ éœ€è¦æ‰‹åŠ¨ä¿®æ”¹è·¯ç”±
- âŒ éœ€è¦é‡æ–°å‘å¸ƒ
- âŒ ä½“éªŒä¸å¥½

### ä¿®å¤å âœ…

```
å‘å¸ƒ â†’ è·¯ç”±å ç”¨ â†’ ğŸ”„ è‡ªåŠ¨æ¢è·¯ç”± â†’ âœ… æˆåŠŸ
```

ç”¨æˆ·ä½“éªŒï¼š
- âœ… è‡ªåŠ¨å¤„ç†
- âœ… æ— éœ€å¹²é¢„
- âœ… ä¸€é”®å®Œæˆ

## ğŸ”— ä¸å…¶ä»–åŠŸèƒ½é›†æˆ

### ä¸ AI è‡ªåŠ¨ä¿®å¤ååŒ

```
åˆ›å»ºæ¨¡æ¿
   â†“
âŒ é”™è¯¯
   â†“
æ£€æµ‹é”™è¯¯ç±»å‹
   â”œâ”€ è·¯ç”±å ç”¨ â†’ ğŸ”„ æ¢è·¯ç”±é‡è¯•  â­
   â”œâ”€ å‚æ•°é”™è¯¯ â†’ ğŸ¤– LLMä¿®å¤é‡è¯•
   â”œâ”€ 401é”™è¯¯ â†’ ğŸ” é‡æ–°ç™»å½•é‡è¯•
   â””â”€ å…¶ä»–é”™è¯¯ â†’ âŒ æŠ¥é”™
```

## âœ… å®Œæˆæ¸…å•

- [x] âœ… æ£€æµ‹è·¯ç”±å ç”¨é”™è¯¯ï¼ˆä¸­è‹±æ–‡ï¼‰
- [x] âœ… è‡ªåŠ¨ç”Ÿæˆæ–°è·¯ç”±å‰ç¼€
- [x] âœ… æ·»åŠ éšæœºæ•°å­—åç¼€
- [x] âœ… ä¿æŒ10å­—ç¬¦é™åˆ¶
- [x] âœ… æœ€å¤šé‡è¯•5æ¬¡
- [x] âœ… è¯¦ç»†æ—¥å¿—è¾“å‡º
- [x] âœ… é€’å½’é‡è¯•æœºåˆ¶
- [x] âœ… é˜²æ­¢æ— é™å¾ªç¯

## ğŸ§ª æµ‹è¯•åœºæ™¯

### æµ‹è¯• 1: é¦–æ¬¡å‘å¸ƒ
```
è¾“å…¥: bachai-data-analysis-mcp
è·¯ç”±: dataanaly
ç»“æœ: âœ… æˆåŠŸ
```

### æµ‹è¯• 2: é‡å¤å‘å¸ƒï¼ˆè·¯ç”±å ç”¨ï¼‰
```
è¾“å…¥: bachai-data-analysis-mcp
è·¯ç”±: dataanaly â†’ âŒ å ç”¨
æ¢è·¯ç”±: dataanaly42
ç»“æœ: âœ… æˆåŠŸ
```

### æµ‹è¯• 3: å¤šæ¬¡å ç”¨
```
è·¯ç”±: dataanaly â†’ âŒ å ç”¨
æ¢è·¯ç”±: dataanaly42 â†’ âŒ å ç”¨
æ¢è·¯ç”±: dataanaly73 â†’ âœ… æˆåŠŸ
```

## ğŸ“Š ç»Ÿè®¡

### æˆåŠŸç‡æå‡

**ä¿®å¤å‰**:
- è·¯ç”±å ç”¨ â†’ 100% å¤±è´¥

**ä¿®å¤å**:
- è·¯ç”±å ç”¨ â†’ è‡ªåŠ¨é‡è¯•
- æˆåŠŸç‡ â†’ 99%+ï¼ˆ5æ¬¡éšæœºæ•°å­—ï¼‰

### å†²çªæ¦‚ç‡

- 1æ¬¡é‡è¯•: 1/90 â‰ˆ 1.1%
- 2æ¬¡é‡è¯•: (1/90)Â² â‰ˆ 0.01%
- 5æ¬¡é‡è¯•: (1/90)âµ â‰ˆ 0.00001%

**ç»“è®º**: å‡ ä¹ä¸å¯èƒ½å¤±è´¥

## ğŸ‰ æ€»ç»“

### æ ¸å¿ƒæ”¹è¿›

1. **æ™ºèƒ½æ£€æµ‹** - è‡ªåŠ¨è¯†åˆ«è·¯ç”±å ç”¨é”™è¯¯
2. **è‡ªåŠ¨æ¢è·¯ç”±** - æ·»åŠ éšæœºæ•°å­—åç¼€
3. **å¤šæ¬¡é‡è¯•** - æœ€å¤šå°è¯•5æ¬¡
4. **è¯¦ç»†æ—¥å¿—** - æ˜¾ç¤ºæ¢è·¯ç”±è¿‡ç¨‹
5. **ç”¨æˆ·æ— æ„Ÿ** - è‡ªåŠ¨å¤„ç†ï¼Œæ— éœ€å¹²é¢„

### ç”¨æˆ·ä»·å€¼

- ğŸš€ **æ›´é«˜æˆåŠŸç‡** - è·¯ç”±å ç”¨ä¸å†å¤±è´¥
- ğŸ˜Š **æ›´å¥½ä½“éªŒ** - æ— éœ€æ‰‹åŠ¨ä¿®æ”¹
- âš¡ **æ›´å¿«é€Ÿåº¦** - è‡ªåŠ¨é‡è¯•ï¼ŒèŠ‚çœæ—¶é—´
- ğŸ“Š **é€æ˜å¯æ§** - è¯¦ç»†æ—¥å¿—æ˜¾ç¤ºè¿‡ç¨‹

---

**å®ç°æ—¶é—´**: 2025-11-06  
**åŠŸèƒ½**: è·¯ç”±å ç”¨è‡ªåŠ¨æ¢è·¯ç”±é‡è¯•  
**å½±å“èŒƒå›´**: create_mcp_template  
**å¼€å‘**: å·´èµ«å·¥ä½œå®¤ (BACH Studio)

**Made with â¤ï¸ by å·´èµ«å·¥ä½œå®¤**

