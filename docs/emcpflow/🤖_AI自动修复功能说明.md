# ğŸ¤– AI è‡ªåŠ¨ä¿®å¤åŠŸèƒ½è¯´æ˜

## åŠŸèƒ½æ¦‚è¿°

å½“ EMCP API è¿”å›é”™è¯¯æ—¶ï¼Œç³»ç»Ÿä¼šï¼š
1. âœ… æ•è·é”™è¯¯ä¿¡æ¯
2. âœ… å°†é”™è¯¯å’Œæ•°æ®å‘é€ç»™ LLM
3. âœ… LLM åˆ†æé”™è¯¯åŸå› 
4. âœ… LLM è‡ªåŠ¨ä¿®å¤æ•°æ®
5. âœ… é‡æ–°å‘é€è¯·æ±‚
6. âœ… æ‰€æœ‰è¿‡ç¨‹éƒ½è®°å½•åˆ°æ—¥å¿—

---

## å·¥ä½œæµç¨‹

```
å‘é€è¯·æ±‚åˆ° EMCP
    â†“
æ”¶åˆ° 400 é”™è¯¯ï¼Ÿ
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1. æ‰“å°é”™è¯¯è¯¦æƒ…åˆ°æ—¥å¿—   â”‚
â”‚ 2. æ‰“å°å‘é€çš„æ•°æ®       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
è¿˜æœ‰é‡è¯•æ¬¡æ•°ï¼Ÿ(æœ€å¤š3æ¬¡)
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è°ƒç”¨ Azure OpenAI       â”‚
â”‚ - å‘é€é”™è¯¯å“åº”          â”‚
â”‚ - å‘é€å½“å‰æ•°æ®          â”‚
â”‚ - å‘é€æ ¼å¼è¦æ±‚          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ LLM åˆ†æé”™è¯¯            â”‚
â”‚ - æ‰¾å‡ºé—®é¢˜å­—æ®µ          â”‚
â”‚ - ç†è§£é”™è¯¯åŸå›           â”‚
â”‚ - ä¿®å¤æ•°æ®              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ è¿”å›ä¿®å¤åçš„æ•°æ®        â”‚
â”‚ {                       â”‚
â”‚   "error_analysis": "...",â”‚
â”‚   "fixed_fields": [...],â”‚
â”‚   "fixed_template_data": {...}â”‚
â”‚ }                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
é‡æ–°å‘é€è¯·æ±‚
    â†“
æˆåŠŸ âœ… æˆ– ç»§ç»­é‡è¯•
```

---

## æ—¥å¿—ç¤ºä¾‹

### ç¬¬1æ¬¡è¯·æ±‚ï¼ˆå¤±è´¥ï¼‰

```
ğŸŒ æ­¥éª¤ 4/4: å‘å¸ƒåˆ° EMCP å¹³å°...
   æ£€æŸ¥æ˜¯å¦å·²å­˜åœ¨...
   ï¼ˆå¦‚é‡é”™è¯¯ï¼ŒLLM ä¼šè‡ªåŠ¨åˆ†æå¹¶ä¿®å¤å‚æ•°ï¼‰

ğŸ“‹ æ¨¡æ¿æ•°æ®è¯¦æƒ…:
======================================================================
{
  "name": [
    {"type": 1, "content": "æ™ºèƒ½æ–‡ä»¶æœç´¢æœåŠ¡"},
    {"type": 2, "content": "æ™ºèƒ½æª”æ¡ˆæœå°‹æœå‹™"},
    {"type": 3, "content": "Intelligent File Search Service"}
  ],
  "template_category_id": "wrong-format",  // âŒ é”™è¯¯çš„æ ¼å¼
  ...
}
======================================================================

âŒ API è¿”å›é”™è¯¯ (çŠ¶æ€ç : 400)
   é”™è¯¯è¯¦æƒ…: {
     "err_code": 1001,
     "err_message": "template_category_id æ ¼å¼é”™è¯¯"
   }
```

### LLM è‡ªåŠ¨ä¿®å¤

```
ğŸ¤– å°è¯•ä½¿ç”¨ LLM è‡ªåŠ¨ä¿®å¤... (é‡è¯• 1/3)
   âœ… LLM å·²ä¿®å¤æ•°æ®ï¼Œé‡æ–°å‘é€...
   
   LLM åˆ†æ:
   - é”™è¯¯: template_category_id åº”è¯¥æ˜¯æœ‰æ•ˆçš„åˆ†ç±»ID
   - ä¿®å¤: å°† "wrong-format" æ”¹ä¸º "1"

ğŸ“‹ ä¿®å¤åçš„æ•°æ®:
{
  "template_category_id": "1",  // âœ… å·²ä¿®å¤
  ...
}
```

### ç¬¬2æ¬¡è¯·æ±‚ï¼ˆæˆåŠŸï¼‰

```
âœ… æ¨¡æ¿å·²åˆ›å»ºï¼

ğŸ‰ å‘å¸ƒå®Œæˆï¼
```

---

## å®ç°ç»†èŠ‚

### æ ¸å¿ƒç±»ï¼šAIErrorFixer

**ä½ç½®**ï¼š`error_fixer.py`

**æ–¹æ³•**ï¼š
```python
class AIErrorFixer:
    def fix_template_data(
        self,
        template_data: Dict,      # åŸå§‹æ•°æ®
        error_response: Dict,     # API é”™è¯¯å“åº”
        error_message: str        # é”™è¯¯ä¿¡æ¯
    ) -> Optional[Dict]:
        """
        ä½¿ç”¨ LLM åˆ†æé”™è¯¯å¹¶ä¿®å¤
        
        Returns:
            ä¿®å¤åçš„æ¨¡æ¿æ•°æ® æˆ– None
        """
```

### é›†æˆåˆ° EMCPManager

**ä½ç½®**ï¼š`emcp_manager.py`

**æ–¹æ³•**ï¼š
```python
def create_mcp_template(
    self,
    template_data: Dict,
    retry_count: int = 0,
    max_retries: int = 3  # æœ€å¤šé‡è¯•3æ¬¡
) -> Dict:
    """
    åˆ›å»ºæ¨¡æ¿ï¼Œæ”¯æŒ AI è‡ªåŠ¨ä¿®å¤é‡è¯•
    """
    
    # å‘é€è¯·æ±‚
    response = requests.post(...)
    
    # å¦‚æœå¤±è´¥ä¸”è¿˜æœ‰é‡è¯•æ¬¡æ•°
    if response.status_code != 200 and retry_count < max_retries:
        # ä½¿ç”¨ AI ä¿®å¤
        fixed_data = self._try_fix_with_ai(...)
        
        if fixed_data:
            # é€’å½’è°ƒç”¨ï¼Œé‡è¯•
            return self.create_mcp_template(
                fixed_data,
                retry_count + 1
            )
```

---

## LLM Prompt ç»“æ„

### è¾“å…¥ä¿¡æ¯

1. **é”™è¯¯ä¿¡æ¯**
   - HTTP çŠ¶æ€ç 
   - API é”™è¯¯å“åº”ï¼ˆJSONï¼‰

2. **å½“å‰æ•°æ®**
   - å®Œæ•´çš„ template_dataï¼ˆJSONï¼‰

3. **æ ¼å¼è¦æ±‚**
   - æ‰€æœ‰å­—æ®µçš„ç±»å‹å’Œè§„åˆ™
   - å¤šè¯­è¨€æ•°ç»„æ ¼å¼
   - å¸¸è§é”™è¯¯åŠä¿®å¤æ–¹æ³•

### è¾“å‡ºæ ¼å¼

```json
{
  "error_analysis": "template_category_id æ ¼å¼é”™è¯¯ï¼Œåº”è¯¥æ˜¯æœ‰æ•ˆçš„UUID",
  "fixed_fields": ["template_category_id"],
  "fixed_template_data": {
    // å®Œæ•´çš„ä¿®å¤åçš„æ•°æ®
  }
}
```

---

## å¸¸è§é”™è¯¯ç±»å‹

### 1. å­—æ®µç±»å‹é”™è¯¯

**é”™è¯¯**ï¼š
```json
{
  "package_type": "1"  // âŒ å­—ç¬¦ä¸²
}
```

**LLM ä¿®å¤**ï¼š
```json
{
  "package_type": 1  // âœ… æ•´æ•°
}
```

### 2. ç©ºå€¼é”™è¯¯

**é”™è¯¯**ï¼š
```json
{
  "command": null  // âŒ null
}
```

**LLM ä¿®å¤**ï¼š
```json
{
  "command": ""  // âœ… ç©ºå­—ç¬¦ä¸²
}
```

### 3. å¤šè¯­è¨€æ•°ç»„é”™è¯¯

**é”™è¯¯**ï¼š
```json
{
  "name": [
    {"type": 1, "content": "æµ‹è¯•"}
    // âŒ ç¼ºå°‘ type 2 å’Œ 3
  ]
}
```

**LLM ä¿®å¤**ï¼š
```json
{
  "name": [
    {"type": 1, "content": "æµ‹è¯•"},
    {"type": 2, "content": "æ¸¬è©¦"},
    {"type": 3, "content": "Test"}
  ]  // âœ… 3ä¸ªå…ƒç´ 
}
```

### 4. è·¯ç”±æ ¼å¼é”™è¯¯

**é”™è¯¯**ï¼š
```json
{
  "route_prefix": "test-route"  // âŒ åŒ…å«æ¨ªæ 
}
```

**LLM ä¿®å¤**ï¼š
```json
{
  "route_prefix": "testroute"  // âœ… ä»…å­—æ¯æ•°å­—
}
```

---

## é…ç½®è¯´æ˜

### è‡ªåŠ¨å¯ç”¨

åªè¦é…ç½®äº† Azure OpenAIï¼ŒAI è‡ªåŠ¨ä¿®å¤åŠŸèƒ½å°±ä¼šå¯ç”¨ã€‚

### é‡è¯•æ¬¡æ•°

é»˜è®¤æœ€å¤šé‡è¯• 3 æ¬¡ï¼š
- ç¬¬1æ¬¡å¤±è´¥ â†’ LLM ä¿®å¤ â†’ é‡è¯•
- ç¬¬2æ¬¡å¤±è´¥ â†’ LLM ä¿®å¤ â†’ é‡è¯•
- ç¬¬3æ¬¡å¤±è´¥ â†’ LLM ä¿®å¤ â†’ é‡è¯•
- ç¬¬4æ¬¡å¤±è´¥ â†’ åœæ­¢ï¼ŒæŠ¥å‘Šé”™è¯¯

### æˆæœ¬æ§åˆ¶

- æ¯æ¬¡ä¿®å¤è°ƒç”¨ 1 æ¬¡ LLMï¼ˆçº¦ 2000 tokensï¼‰
- æˆæœ¬ï¼šçº¦ $0.01-0.02 æ¯æ¬¡ä¿®å¤
- å¦‚æœ 3 æ¬¡éƒ½å¤±è´¥ï¼Œæ€»æˆæœ¬çº¦ $0.03-0.06

---

## ä½¿ç”¨ç¤ºä¾‹

### åœºæ™¯ï¼šåˆ†ç±» ID é”™è¯¯

```bash
python emcpflow_simple_gui.py

# è¾“å…¥åŒ…å
requests

# å‘å¸ƒè¿‡ç¨‹ï¼š
```

**æ—¥å¿—è¾“å‡º**ï¼š

```
ğŸ“‹ æ¨¡æ¿æ•°æ®è¯¦æƒ…:
{
  "template_category_id": "é”™è¯¯çš„ID",
  ...
}

âŒ API è¿”å›é”™è¯¯ (çŠ¶æ€ç : 400)
   é”™è¯¯è¯¦æƒ…: {
     "err_message": "åˆ†ç±»IDä¸å­˜åœ¨"
   }

ğŸ¤– å°è¯•ä½¿ç”¨ LLM è‡ªåŠ¨ä¿®å¤... (é‡è¯• 1/3)
   LLM åˆ†æ: åˆ†ç±»IDæ ¼å¼é”™è¯¯ï¼Œåº”è¯¥ä»çœŸå®åˆ†ç±»åˆ—è¡¨é€‰æ‹©
   LLM ä¿®å¤: å°† "é”™è¯¯çš„ID" æ”¹ä¸º "1"
   âœ… LLM å·²ä¿®å¤æ•°æ®ï¼Œé‡æ–°å‘é€...

ğŸ“‹ ä¿®å¤åçš„æ•°æ®:
{
  "template_category_id": "1",  // âœ… å·²ä¿®å¤
  ...
}

âœ… æ¨¡æ¿å·²åˆ›å»ºï¼

ğŸ‰ å‘å¸ƒå®Œæˆï¼
```

---

## ä¼˜åŠ¿

### 1. è‡ªåŠ¨è¯Šæ–­

- âœ… LLM ç†è§£é”™è¯¯ä¿¡æ¯
- âœ… LLM çŸ¥é“æ•°æ®æ ¼å¼è¦æ±‚
- âœ… LLM æ‰¾å‡ºé—®é¢˜å­—æ®µ

### 2. è‡ªåŠ¨ä¿®å¤

- âœ… ç±»å‹è½¬æ¢ï¼ˆå­—ç¬¦ä¸² â†” æ•´æ•°ï¼‰
- âœ… ç©ºå€¼å¤„ç†ï¼ˆnull â†’ ""ï¼‰
- âœ… æ ¼å¼è§„èŒƒåŒ–
- âœ… ç¼ºå¤±å­—æ®µè¡¥å……

### 3. ç”¨æˆ·ä½“éªŒ

- âœ… ç”¨æˆ·æ— æ„ŸçŸ¥
- âœ… è‡ªåŠ¨é‡è¯•
- âœ… è¯¦ç»†æ—¥å¿—
- âœ… æˆåŠŸç‡æé«˜

---

## æŠ€æœ¯ç»†èŠ‚

### é‡è¯•æœºåˆ¶

```python
def create_mcp_template(template_data, retry_count=0, max_retries=3):
    # å‘é€è¯·æ±‚
    response = post(...)
    
    # å¦‚æœå¤±è´¥
    if response.status_code != 200:
        # å¦‚æœè¿˜æœ‰é‡è¯•æ¬¡æ•°
        if retry_count < max_retries:
            # AI ä¿®å¤
            fixed_data = fix_with_ai(...)
            
            # é€’å½’é‡è¯•
            return create_mcp_template(
                fixed_data,
                retry_count + 1
            )
    
    # æˆåŠŸ
    return response.json()
```

### é”™è¯¯ä¼ é€’

```python
# ä¼ é€’ç»™ LLM çš„ä¿¡æ¯
{
  "error": {
    "status_code": 400,
    "response": {...}
  },
  "data": {
    "template_data": {...}
  },
  "requirements": {
    "field_types": {...},
    "rules": {...}
  }
}
```

---

## ğŸ¯ æ€»ç»“

### æ ¸å¿ƒç‰¹æ€§

- ğŸ¤– **AI é©±åŠ¨** - LLM è‡ªåŠ¨è¯Šæ–­å’Œä¿®å¤
- ğŸ”„ **è‡ªåŠ¨é‡è¯•** - æœ€å¤š 3 æ¬¡
- ğŸ“‹ **è¯¦ç»†æ—¥å¿—** - æ‰€æœ‰è¿‡ç¨‹å¯è§
- âœ… **é«˜æˆåŠŸç‡** - å¤§å¤šæ•°é”™è¯¯éƒ½èƒ½è‡ªåŠ¨ä¿®å¤

### é€‚ç”¨åœºæ™¯

1. **API æ ¼å¼æ›´æ–°** - è‡ªåŠ¨é€‚é…
2. **å‚æ•°é”™è¯¯** - è‡ªåŠ¨ä¿®æ­£
3. **ç±»å‹é”™è¯¯** - è‡ªåŠ¨è½¬æ¢
4. **è§„åˆ™å˜æ›´** - è‡ªåŠ¨è°ƒæ•´

### ç”¨æˆ·ä½“éªŒ

**å®Œå…¨é€æ˜**ï¼š
- ç”¨æˆ·çœ‹åˆ°è¯¦ç»†æ—¥å¿—
- çŸ¥é“å‘ç”Ÿäº†ä»€ä¹ˆ
- ç†è§£å¦‚ä½•ä¿®å¤çš„
- å­¦ä¹ æ­£ç¡®çš„æ ¼å¼

---

**AI è‡ªåŠ¨ä¿®å¤åŠŸèƒ½å·²å®ç°ï¼** ğŸ‰  
**è®© LLM æˆä¸ºæ‚¨çš„æ™ºèƒ½åŠ©æ‰‹ï¼** ğŸ¤–  
**å¤§å¹…æé«˜å‘å¸ƒæˆåŠŸç‡ï¼** âœ…


