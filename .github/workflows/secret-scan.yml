# Secret Scanning Workflow
# åœ¨ push å’Œ PR æ—¶è‡ªåŠ¨æ‰«ææ•æ„Ÿä¿¡æ¯

name: ðŸ” Secret Scan

on:
  push:
    branches: [main, master, develop]
  pull_request:
    branches: [main, master, develop]
  # å…è®¸æ‰‹åŠ¨è§¦å‘
  workflow_dispatch:

jobs:
  # æ–¹æ¡ˆ 1: TruffleHog æ‰«æ
  trufflehog:
    name: ðŸ· TruffleHog Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # èŽ·å–å®Œæ•´åŽ†å²ç”¨äºŽæ‰«æ

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  # æ–¹æ¡ˆ 2: Gitleaks æ‰«æ
  gitleaks:
    name: ðŸ” Gitleaks Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Gitleaks
        uses: gitleaks/gitleaks-action@v2
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          GITLEAKS_LICENSE: ${{ secrets.GITLEAKS_LICENSE }}  # å¯é€‰ï¼Œå…è´¹ç‰ˆä¸éœ€è¦

  # æ–¹æ¡ˆ 3: è‡ªå®šä¹‰ Secret Scanner
  custom-scanner:
    name: ðŸ›¡ï¸ RepoFlow Secret Scanner
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Run Secret Scanner
        run: |
          python -c "
          import sys
          from pathlib import Path
          sys.path.insert(0, str(Path('.').absolute()))
          from src.secret_scanner import SecretScanner
          
          scanner = SecretScanner()
          issues = scanner.scan_directory(Path('.'))
          
          if issues:
              print('::error::âŒ å‘çŽ°æ•æ„Ÿä¿¡æ¯!')
              for issue in issues:
                  print(f'::warning file={issue[\"file\"]},line={issue[\"line\"]}::{issue[\"type\"]}: {issue[\"match\"][:50]}...')
              print(f'')
              print(f'å…±å‘çŽ° {len(issues)} ä¸ªæ½œåœ¨çš„æ•æ„Ÿä¿¡æ¯æ³„éœ²')
              print('')
              print('è¯·æ£€æŸ¥å¹¶ç§»é™¤è¿™äº›æ•æ„Ÿä¿¡æ¯ï¼Œç„¶åŽï¼š')
              print('1. ä½¿ç”¨çŽ¯å¢ƒå˜é‡æ›¿ä»£ç¡¬ç¼–ç ')
              print('2. å°†æ•æ„Ÿæ–‡ä»¶æ·»åŠ åˆ° .gitignore')
              print('3. å¦‚æžœå·²ç»æäº¤ï¼Œéœ€è¦æ¸…ç† git åŽ†å²')
              sys.exit(1)
          else:
              print('âœ… æœªå‘çŽ°æ•æ„Ÿä¿¡æ¯æ³„éœ²')
          "

  # æ±‡æ€»ç»“æžœ
  summary:
    name: ðŸ“Š Security Summary
    needs: [trufflehog, gitleaks, custom-scanner]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check results
        run: |
          echo "## ðŸ” å®‰å…¨æ‰«æç»“æžœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ needs.trufflehog.result }}" == "success" ]; then
            echo "- âœ… TruffleHog: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ TruffleHog: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.gitleaks.result }}" == "success" ]; then
            echo "- âœ… Gitleaks: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ Gitleaks: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [ "${{ needs.custom-scanner.result }}" == "success" ]; then
            echo "- âœ… RepoFlow Scanner: é€šè¿‡" >> $GITHUB_STEP_SUMMARY
          else
            echo "- âŒ RepoFlow Scanner: å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          fi








